pipeline {
  agent any

  stages {
    stage('Secrets Setup') {
      steps {
        withCredentials([
          file(credentialsId: 'env-file', variable: 'EnvFile'),
        ]) {
          sh '''
            cp "$EnvFile" ./frontend/.env
            chmod 644 ./frontend/.env
          '''
        }
      }
    }

    stage('Build Frontend') {
      steps {
        sh '''
          docker run --rm \
            -v $PWD/frontend:/app \
            -w /app \
            node:20-alpine \
            sh -c "npm install && npm run build || true"
        '''
      }
    }

    stage('Deploy to Nginx') {
      steps {
        sh '''
          mkdir -p /home/ubuntu/nginx
          rm -rf /home/ubuntu/nginx/*
          cp -r ./frontend/dist/* /home/ubuntu/nginx/
        '''
      }
    }
  }
}
